<!DOCTYPE html>
<html lang="{{ site.lang | default: 'en-US' }}">
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="{{ '/assets/css/style.css?v=' | append: site.github.build_revision | relative_url }}" media="screen" type="text/css">
    <link rel="stylesheet" href="{{ '/assets/css/print.css' | relative_url }}" media="print" type="text/css">
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <![endif]-->
    {% seo %}
    {% include head-custom.html %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/turndown/7.1.1/turndown.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdownlint@0.23.2/lib/markdownlint.min.js"></script>
  
  </head>

  <body>
    <header>
      <div class="inner">
        <a href="{{ '/' | absolute_url }}">
          <h1>{{ site.title | default: site.github.repository_name }}</h1>
        </a>
        <h2>{{ site.description | default: site.github.project_tagline }}</h2>
        {% if site.github.is_project_page %}
          <a href="{{ site.github.repository_url }}" class="button"><small>View project on</small> GitHub</a>
        {% endif %}
      </div>
    </header>

    <div id="content-wrapper">
      <div class="inner clearfix">
        <section id="main-content">
          <h1>DOCX to Markdown Converter</h1>
          <p>Upload a DOCX file to convert it to Markdown:</p>

          <!-- File Upload Input -->
          <input type="file" id="fileInput" accept=".docx">

          <!-- Download Button -->
          <button id="downloadBtn" style="display:none;" onclick="downloadMarkdown()">Download Markdown</button>

          <!-- Output Area for Converted Markdown -->
          <h2>Converted Markdown:</h2>
          <pre id="output"></pre>

          <!-- Conversion Script with Automatic Correction -->
          <script>
            let convertedMarkdown = '';

            document.getElementById('fileInput').addEventListener('change', function(event) {
              const file = event.target.files[0];
              if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                  const arrayBuffer = event.target.result;
                  mammoth.convertToHtml({arrayBuffer: arrayBuffer})
                    .then(function(result) {
                      const turndownService = new TurndownService();
                      convertedMarkdown = turndownService.turndown(result.value);

                      // Lint and automatically correct the Markdown
                      convertedMarkdown = lintAndCorrectMarkdown(convertedMarkdown);

                      // Display the converted (and corrected) Markdown
                      document.getElementById('output').textContent = convertedMarkdown;
                      document.getElementById('downloadBtn').style.display = 'block';
                    })
                    .catch(function(error) {
                      console.error('Conversion error: ', error);
                    });
                };
                reader.readAsArrayBuffer(file);
              }
            });

            function lintAndCorrectMarkdown(markdown) {
              const results = markdownlint.sync({
                strings: {
                  content: markdown
                },
                config: {
                  "default": true,
                  "MD007": false  // Disable indentation rule for lists as an example
                }
              });

              // Iterate over the linting results and apply corrections
              results.content.forEach(issue => {
                switch (issue.ruleNames[0]) {
                  case "MD009":  // Trailing spaces
                    markdown = markdown.replace(/ +$/gm, '');
                    break;
                  case "MD018":  // No space after hash on atx style header
                    markdown = markdown.replace(/^(#+)([^\s#])/gm, '$1 $2');
                    break;
                  case "MD022":  // Headers should be surrounded by blank lines
                    markdown = markdown.replace(/([^\n])\n(#+)/g, '$1\n\n$2');
                    markdown = markdown.replace(/(#+[^\n]*)\n([^\n#])/g, '$1\n\n$2');
                    break;
                  // Add more cases as needed for other rules you want to correct
                }
              });

              return markdown;
            }

            function downloadMarkdown() {
              const blob = new Blob([convertedMarkdown], {type: 'text/markdown'});
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = 'converted.md';
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              URL.revokeObjectURL(url);  // Clean up the URL object
            }
          </script>

          <h2>README:</h2>
          {{ content }}
        </section>

        <aside id="sidebar">
          {% if site.show_downloads %}
            <a href="{{ site.github.zip_url }}" class="button">
              <small>Download</small>
              .zip file
            </a>
          {% endif %}

          {% if site.github.is_project_page %}
            <p class="repo-owner"><a href="{{ site.github.repository_url }}">{{ site.github.repository_name }}</a> is maintained by <a href="{{ site.github.owner_url }}">{{ site.github.owner_name }}</a>.</p>
          {% endif %}

          <p>This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</p>
        </aside>
      </div>
    </div>
  </body>
</html>
